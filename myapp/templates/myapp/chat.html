{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatMCA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">

    <style>
        body { font-family: 'Roboto', 'Google Sans', sans-serif; background-color: #f0f4f9; overflow: hidden; /* Prevent body scroll */ }
        .page-container { height: 100vh; }
        .sidebar { background-color: #e3f2fd; padding: 1rem; display: flex; flex-direction: column; height: 100vh; }
        .history-links { flex-grow: 1; overflow-y: auto; }
        .history-item { display: flex; align-items: center; margin-bottom: 0.5rem; border-radius: 0.5rem; transition: background-color 0.2s ease; }
        .history-item:hover, .history-item.active { background-color: #d1e9fc; }
        .history-item.active { background-color: #ffffff; }
        .history-link { flex-grow: 1; padding: 0.75rem 1rem; color: #1f1f1f; text-decoration: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-actions { display: flex; padding-right: 0.5rem; opacity: 0; transition: opacity 0.2s; }
        .history-item:hover .history-actions { opacity: 1; }
        .action-btn { background: none; border: none; cursor: pointer; color: #5f6368; padding: 0.25rem; }
        .action-btn:hover { color: #000; }
        
        .chat-area { padding: 0 !important; height: 100vh; display: flex; flex-direction: column; }
        .chat-container { width: 100%; height: 100%; display: flex; flex-direction: column; background-color: #ffffff; box-shadow: none; border-left: 1px solid #dee2e6;}
        .chat-header { padding: 1rem 1.5rem; border-bottom: 1px solid #dee2e6; flex-shrink: 0; }
        .chat-box { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message { margin-bottom: 1.5rem; display: flex; animation: fade-in-up 0.3s ease-out; position: relative; }
        .message p { padding: 0.75rem 1.25rem; border-radius: 1.25rem; margin-bottom: 0; color: #1f1f1f; }
        .user-message { justify-content: flex-end; }
        .user-message p { background-color: #e3f2fd; border-bottom-right-radius: 0.25rem; }
        .bot-message { justify-content: flex-start; align-items: flex-start; gap: 0.75rem; }
        .bot-message::before { content: ''; display: block; flex-shrink: 0; width: 32px; height: 32px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%234285F4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z'/%3E%3C/svg%3E"); background-size: 24px 24px; background-repeat: no-repeat; background-position: center; background-color: #e3f2fd; border-radius: 50%; }
        .bot-message p { background-color: #f1f3f4; border-bottom-left-radius: 0.25rem; }
        .copy-btn { position: absolute; bottom: -10px; left: 45px; background: #ffffff; border: 1px solid #dee2e6; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.2s ease; }
        .bot-message:hover .copy-btn { opacity: 1; }
        .suggestions-container { padding: 0 1.5rem 1rem 54px; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .suggestion-btn { background: none; border: 1px solid #dee2e6; border-radius: 1rem; padding: 0.5rem 1rem; font-size: 0.875rem; color: #3c4043; transition: background-color 0.2s ease; }
        .chat-input-container { padding: 1rem 1.5rem; }
        .chat-input { background-color: #f1f3f4; border-radius: 2rem; padding: 0.5rem; }
        .chat-input .form-control { background: transparent; border: none; box-shadow: none !important; }
        .chat-input .btn { border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .thinking-animation { width: 100%; height: 4px; background: linear-gradient(90deg, #f0f4f9, #1a73e8, #f0f4f9); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; border-radius: 2px; margin-top: 8px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>
    <div class="container-fluid page-container">
        <div class="row h-100">
            <div class="col-md-3 sidebar">
                <a href="{% url 'new_chat' %}" class="btn btn-light mb-3 w-100">New Chat</a>
                <nav class="history-links" id="history-links">
                    {% for session in user_chat_sessions %}
                    <div class="history-item {% if session.id == current_chat_id %}active{% endif %}" data-session-id="{{ session.id }}">
                        <a href="{% url 'chat_view' session.id %}" class="history-link">{{ session.title }}</a>
                        <div class="history-actions">
                            <button class="action-btn rename-btn" title="Rename"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-fill" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.5.5 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11z"/></svg></button>
                            <button class="action-btn delete-btn" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/></svg></button>
                        </div>
                    </div>
                    {% endfor %}
                </nav>
            </div>
            <main class="col-md-9 chat-area">
                <div class="chat-container">
                    <header class="chat-header"><h1 class="h6 mb-0 fw-bold text-secondary">ChatMCA</h1></header>
                    <div class="chat-box" id="chat-box"></div>
                    <div id="suggestions-placeholder"></div>
                    <div class="text-center py-2" id="stop-generating-container" style="display: none;">
                         <button id="stop-btn" class="btn btn-sm btn-danger">Stop generating</button>
                    </div>
                    <footer class="chat-input-container">
                        <form id="chat-form">
                            {% csrf_token %}
                            <div class="input-group chat-input">
                                <input type="text" id="user-input" class="form-control" placeholder="Type your message..." autocomplete="off" autofocus>
                                <button class="btn btn-primary" type="submit" aria-label="Send"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-up" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/></svg></button>
                            </div>
                        </form>
                    </footer>
                </div>
            </main>
        </div>
    </div>
    <script id="session-data" type="application/json">{ "session_id": "{{ session_id|stringformat:'s' }}", "history": {{ message_history_json|safe }}, "title": "{{ user_chat_sessions.0.title }}" }</script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="{% static 'js/main.js' %}"></script>
</body>
</html>